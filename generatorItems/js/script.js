document.addEventListener("DOMContentLoaded", () => {
    // Базы данных для генерации с градацией по редкости
    const itemThemes = {
        "protection": {
            names: {
                "common": {
                    "доспех/щит": ["Щит Новичка", "Нагрудник Ученика", "Простой Защитный Амулет"],
                    "кольцо": ["Кольцо Малой Защиты", "Перстень Начинающего"]
                },
                "uncommon": {
                    "доспех/щит": ["Щит Странника", "Нагрудник Искателя", "Шлем Бдительности"],
                    "кольцо": ["Кольцо Защиты", "Кольцо Отражения"]
                },
                "rare": {
                    "доспех/щит": ["Щит Ветерана", "Нагрудник Мастера", "Ботфорты Стража"],
                    "кольцо": ["Кольцо Магического Щита", "Кольцо Непробиваемости"],
                    "артефакт": ["Наплечники Древнего Воина"]
                },
                "veryRare": {
                    "доспех/щит": ["Щит Героя", "Кираса Легенды", "Шлем Несокрушимости"],
                    "кольцо": ["Кольцо Божественной Защиты", "Кольцо Абсолютной Защиты"],
                    "артефакт": ["Щит Мироздания", "Плащ Непробиваемости"]
                },
                "legendary": {
                    "доспех/щит": ["Доспехи Бессмертного", "Щит Богов", "Нагрудник Абсолюта"],
                    "кольцо": ["Кольцо Создателя", "Кольцо Вечной Защиты"],
                    "артефакт": ["Броня Вселенной", "Щит Реальности"]
                }
            },
            properties: {
                "common": [
                    "+1 к КД (постоянно)",
                    "1 раз в день: бонусное действие для получения +2 КД на 1 раунд"
                ],
                "uncommon": [
                    "+1 к КД и спасброскам (постоянно)",
                    "Сопротивление к одному типу урона (действие для смены типа)",
                    "1 раз в день: реакция для уменьшения урона на 1к6"
                ],
                "rare": [
                    "+2 к КД (постоянно)",
                    "Иммунитет к урону одного типа (требует перезарядки после боя)",
                    "1 раз в день: бонусное действие для получения +3 КД до начала следующего хода",
                    "Реакция: при попадании по вам, уменьшите урон на 1к8+3"
                ],
                "veryRare": [
                    "+3 к КД (постоянно)",
                    "Сопротивление к трем типам урона (постоянно)",
                    "1 раз в день: иммунитет к урону на 1 раунд",
                    "Реакция: при попадании, шанс 50% полностью заблокировать урон"
                ],
                "legendary": [
                    "+5 к КД (постоянно)",
                    "Иммунитет ко всем типам урона (постоянно)",
                    "Бонусное действие: создание силового поля на 1 минуту (абсолютная защита)",
                    "Автоматическая стабилизация при падении до 0 хитов",
                    "Воскрешение владельца 1 раз в неделю"
                ]
            }
        },
        
        "attack": {
            names: {
                "common": {
                    "оружие": ["Меч Новичка", "Кинжал Ученика", "Простой Лук"],
                    "посох": ["Посох Начинающего"],
                    "волшебная палочка": ["Палочка Новичка", "Простая Волшебная Палочка"]
                },
                "uncommon": {
                    "оружие": ["Меч Странника", "Секира Искателя", "Лук Охотника"],
                    "посох": ["Посох Элементов", "Палочка Чародея"],
                    "волшебная палочка": ["Палочка Элементов", "Палочка Чародейства"]
                },
                "rare": {
                    "оружие": ["Меч Ветерана", "Секира Мастера", "Молот Воина"],
                    "посох": ["Посох Магического Натиска", "Палочка Разрушения"],
                    "волшебная палочка": ["Палочка Молний", "Палочка Огня"],
                    "артефакт": ["Клинок Героя"]
                },
                "veryRare": {
                    "оружие": ["Меч Легенды", "Молот Громовых Богов", "Коса Теней"],
                    "посох": ["Посох Власти", "Посох Древних"],
                    "волшебная палочка": ["Палочка Власти", "Палочка Древних"],
                    "артефакт": ["Клинок Судьбы", "Секира Титана"]
                },
                "legendary": {
                    "оружие": ["Меч Судного Дня", "Коса Вечной Ночи", "Молот Создателя"],
                    "посох": ["Посох Богов", "Посох Реальности"],
                    "волшебная палочка": ["Палочка Богов", "Палочка Реальности"],
                    "артефакт": ["Оружие Апокалипсиса", "Клинок Мироздания"]
                }
            },
            properties: {
                "common": [
                    "+1 к броскам атаки (постоянно)",
                    "1 раз в день: дополнительный урон 1к4"
                ],
                "uncommon": [
                    "+1 к броскам атаки и урону (постоянно)",
                    "Критический удар на 20 (постоянно)",
                    "1 раз в день: действие для нанесения дополнительного урона 1к6"
                ],
                "rare": [
                    "+2 к броскам атаки и урону (постоянно)",
                    "Критический удар на 19-20 (постоянно)",
                    "Бонусное действие: дополнительная атака 1 раз в бой",
                    "1 раз в день: урон увеличивается на 2к6"
                ],
                "veryRare": [
                    "+3 к броскам атаки и урону (постоянно)",
                    "Критический удар на 18-20 (постоянно)",
                    "Реакция: при промахе, повторный бросок 1 раз в короткий отдых",
                    "1 раз в день: урон увеличивается на 3к8"
                ],
                "legendary": [
                    "+5 к броскам атаки и урону (постоянно)",
                    "Автоматическое попадание по целям (кроме иммунных)",
                    "Критический удар на 17-20 с тройным уроном",
                    "Бонусное действие: дополнительная атака каждый раунд",
                    "Убийство любого существа с менее чем 100 хитами при критическом ударе"
                ]
            }
        },
        
        "magic": {
            names: {
                "common": {
                    "посох": ["Посох Новичка", "Палочка Ученика"],
                    "жезл": ["Жезл Начинающего"],
                    "волшебная палочка": ["Палочка Чар", "Простая Волшебная Палочка"]
                },
                "uncommon": {
                    "посох": ["Посох Элементов", "Палочка Чародея"],
                    "жезл": ["Жезл Мага", "Жезл Стихий"],
                    "волшебная палочка": ["Палочка Защиты", "Палочка Иллюзий"]
                },
                "rare": {
                    "посох": ["Посох Мастера", "Палочка Архимага"],
                    "жезл": ["Жезл Чародея", "Жезл Могущества"],
                    "волшебная палочка": ["Палочка Телекинеза", "Палочка Призыва"],
                    "артефакт": ["Скипетр Мудреца"]
                },
                "veryRare": {
                    "посох": ["Посох Древних", "Палочка Власти"],
                    "жезл": ["Жезл Власти", "Жезл Древних"],
                    "волшебная палочка": ["Палочка Времени", "Палочка Пространства"],
                    "артефакт": ["Скипетр Реальности", "Ядро Магии"]
                },
                "legendary": {
                    "посох": ["Посох Богов", "Посох Создателя"],
                    "жезл": ["Жезл Богов", "Жезл Создателя"],
                    "волшебная палочка": ["Палочка Создателя", "Палочка Судьбы"],
                    "артефакт": ["Скипетр Богов", "Источник Магии", "Сердце Заклинаний"]
                }
            },
            properties: {
                "common": [
                    "1 заряд: наложение заклинания 1-го уровня (восстанавливает 1 заряд на рассвете)",
                    "+1 к КС заклинаний (постоянно)"
                ],
                "uncommon": [
                    "3 заряда: наложение заклинания до 2-го уровня (восстанавливает 1d3 заряда на рассвете)",
                    "+1 к КС заклинаний и атаке заклинаниями (постоянно)",
                    "1 раз в день: преимущество на концентрацию"
                ],
                "rare": [
                    "5 зарядов: наложение заклинания до 3-го уровня (восстанавливает 1d4+1 заряда на рассвете)",
                    "+2 к КС заклинаний (постоянно)",
                    "Бонусное действие: восстановление 1к4 потраченных хитов заклинателя",
                    "1 раз в день: автоматическая концентрация на одном заклинании"
                ],
                "veryRare": [
                    "7 зарядов: наложение заклинания до 5-го уровня (восстанавливает 1d6+1 зарядов на рассвете)",
                    "+3 к КС заклинаний (постоянно)",
                    "Действие: преимущество на все спасброски от заклинаний до конца хода",
                    "1 раз в день: наложение заклинания без материальных компонентов"
                ],
                "legendary": [
                    "Неограниченные заряды: наложение заклинания любого уровня",
                    "+5 к КС заклинаний и всем проверкам магии",
                    "Иммунитет к контрзаклинаниям",
                    "Бонусное действие: отмена одного заклинания, нацеленного на владельца",
                    "1 раз в день: изменение реальности в радиусе 100 футов"
                ]
            }
        },

        "wonder": {
            names: {
                "common": {
                    "чудесный предмет": ["Сумка Хранения", "Неиссякаемая Фляга", "Вечный Факел"],
                    "зелье": ["Простое Зелье Лечения", "Бальзам Новичка"]
                },
                "uncommon": {
                    "чудесный предмет": ["Ковер-Самолет Малый", "Шапка-Невидимка", "Сапоги-Скороходы"],
                    "зелье": ["Зелье Лечения", "Бальзам Странника"]
                },
                "rare": {
                    "чудесный предмет": ["Ковер-Самолет Большой", "Наперсток Памяти", "Зеркало Истины"],
                    "зелье": ["Эликсир Исцеления", "Бальзам Ветерана"],
                    "артефакт": ["Слеза Феникса"]
                },
                "veryRare": {
                    "чудесный предмет": ["Лампа Джинна", "Кольцо Трех Желаний", "Шкатулка Бесконечности"],
                    "зелье": ["Эликсир Возрождения", "Бальзам Легенды"],
                    "артефакт": ["Сердце Дракона", "Источник Жизни"]
                },
                "legendary": {
                    "чудесный предмет": ["Машина Времени", "Портальный Камень", "Сфера Абсолюта"],
                    "зелье": ["Эликсир Бессмертия", "Настой Вечности"],
                    "артефакт": ["Слеза Богини", "Фонтан Бессмертия", "Ядро Жизни"]
                }
            },
            properties: {
                "common": [
                    "Хранит до 50 кг предметов без изменения веса",
                    "Создает бесконечный поток чистой воды",
                    "Светит ярким светом в радиусе 20 футов без топлива"
                ],
                "uncommon": [
                    "Позволяет летать со скоростью 30 футов (концентрация)",
                    "Дает невидимость на 1 час (1 раз в день)",
                    "Увеличивает скорость передвижения на 10 футов"
                ],
                "rare": [
                    "Позволяет летать со скоростью 60 футов с 3 пассажирами",
                    "Хранит до 100 страниц информации, доступной мысленно",
                    "Показывает правду о любом существе или предмете"
                ],
                "veryRare": [
                    "Призывает джинна для исполнения 3 желаний",
                    "Исполняет одно желание в пределах возможного (1 раз в месяц)",
                    "Содержит бесконечное пространство для хранения"
                ],
                "legendary": [
                    "Позволяет путешествовать во времени на 24 часа",
                    "Создает порталы в любую точку мультивселенной",
                    "Дает абсолютный контроль над реальностью в радиусе 1 мили"
                ]
            }
        },
        
        "healing": {
            names: {
                "common": {
                    "зелье": ["Простое Зелье Лечения", "Бальзам Новичка"],
                    "кольцо": ["Кольцо Малого Исцеления"]
                },
                "uncommon": {
                    "зелье": ["Зелье Лечения", "Бальзам Странника"],
                    "кольцо": ["Кольцо Исцеления", "Кольцо Жизни"]
                },
                "rare": {
                    "зелье": ["Эликсир Исцеления", "Бальзам Ветерана"],
                    "посох": ["Посох Исцеления"],
                    "кольцо": ["Кольцо Великого Исцеления"],
                    "артефакт": ["Слеза Феникса"]
                },
                "veryRare": {
                    "зелье": ["Эликсир Возрождения", "Бальзам Легенды"],
                    "посох": ["Посох Возрождения"],
                    "кольцо": ["Кольцо Бессмертия"],
                    "артефакт": ["Сердце Дракона", "Источник Жизни"]
                },
                "legendary": {
                    "зелье": ["Эликсир Бессмертия", "Настой Вечности"],
                    "посох": ["Посох Божественного Исцеления"],
                    "кольцо": ["Кольцо Создателя Жизни"],
                    "артефакт": ["Слеза Богини", "Фонтан Бессмертия", "Ядро Жизни"]
                }
            },
            properties: {
                "common": [
                    "Действие: исцеление 1к4+1 хитов (1 раз в день)",
                    "Стабилизация умирающего существа (1 раз в день)"
                ],
                "uncommon": [
                    "Действие: исцеление 2к4+2 хитов (2 раза в день)",
                    "Бонусное действие: исцеление 1к4 хитов (1 раз в короткий отдых)",
                    "Снятие отравления (1 раз в день)"
                ],
                "rare": [
                    "Действие: исцеление 4к4+4 хитов (3 раза в день)",
                    "Реакция: при падении до 0 хитов, автоматическая стабилизация",
                    "Снятие одного состояния (болезнь, отравление, паралич)",
                    "1 раз в день: воскрешение с 1 хит поинтом"
                ],
                "veryRare": [
                    "Действие: исцеление 8к4+8 хитов (по желанию)",
                    "Постоянно: регенерация 5 хитов каждый раунд",
                    "Автоматическое воскрешение при смерти (1 раз в день)",
                    "Иммунитет к болезням и ядам"
                ],
                "legendary": [
                    "Мгновенное исцеление любого количества урона (по желанию)",
                    "Бессмертие владельца (не может умереть от старости или болезней)",
                    "Воскрешение любого существа, умершего не более года назад",
                    "Создание клонов владельца в безопасных местах",
                    "Контроль над жизнью и смертью в радиусе 1 мили"
                ]
            }
        }
    };

    const itemFeatures = {
        "common": [
            "Слегка светится в темноте",
            "Теплый на ощупь",
            "Простая, но качественная отделка",
            "Легкий и удобный в использовании"
        ],
        "uncommon": [
            "Ярко светится в темноте",
            "Меняет цвет в зависимости от времени суток",
            "Украшен простыми драгоценными камнями",
            "Издает тихое гудение при использовании"
        ],
        "rare": [
            "Украшен редкими драгоценными камнями",
            "На поверхности видны движущиеся узоры",
            "Парит в воздухе когда не используется",
            "Реагирует на лунные фазы"
        ],
        "veryRare": [
            "Создан из неизвестного материала",
            "Содержит заключенную внутри душу",
            "Меняет форму по желанию владельца",
            "Разговаривает с владельцем"
        ],
        "legendary": [
            "Создан из материала, не существующего в этом мире",
            "Содержит душу древнего существа",
            "Существует в нескольких измерениях одновременно",
            "Имеет собственную волю и личность"
        ]
    };

    const itemEffects = {
        "common": [
            "Иногда издает тихие звуки",
            "Слегка меняет температуру",
            "Привлекает внимание кошек"
        ],
        "uncommon": [
            "Меняет цвет волос владельца на несколько часов",
            "Вызывает легкий ветерок вокруг",
            "Заставляет говорить рифмами после использования"
        ],
        "rare": [
            "Создает иллюзию запаха вокруг владельца",
            "Вызывает непроизвольный смех при критических попаданиях",
            "Меняет вкус еды владельца"
        ],
        "veryRare": [
            "Вызывает случайные погодные явления",
            "Заставляет предметы вокруг парить",
            "Создает радугу вокруг владельца в дождь"
        ],
        "legendary": [
            "Изменяет реальность вокруг владельца",
            "Привлекает внимание божеств",
            "Создает временные аномалии"
        ]
    };

    const rarities = {
        common: { name: "Обычный", color: "#808080" },
        uncommon: { name: "Необычный", color: "#00ff00" },
        rare: { name: "Редкий", color: "#0000ff" },
        veryRare: { name: "Очень редкий", color: "#800080" },
        legendary: { name: "Легендарный", color: "#ffa500" }
    };

    // Функция для получения случайного элемента из массива
    const random = (arr) => {
        if (!arr || arr.length === 0) return "—";
        return arr[Math.floor(Math.random() * arr.length)];
    };

    // Функция для получения нескольких случайных элементов
    const randomMultiple = (arr, count) => {
        if (!arr || arr.length === 0) return "—";
        const shuffled = [...arr].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, Math.min(count, shuffled.length)).join(", ");
    };

    // Функция для получения темы на основе типа предмета
    function getThemeForType(itemType) {
        const availableThemes = [];
        
        for (const theme in itemThemes) {
            for (const rarity in itemThemes[theme].names) {
                if (itemThemes[theme].names[rarity][itemType]) {
                    availableThemes.push(theme);
                    break;
                }
            }
        }
        
        return availableThemes.length > 0 ? random(availableThemes) : "protection";
    }

    // Функция для получения доступных редкостей для типа предмета
    function getAvailableRaritiesForType(itemType) {
        const availableRarities = [];
        for (const theme in itemThemes) {
            for (const rarity of ["common", "uncommon", "rare", "veryRare", "legendary"]) {
                if (itemThemes[theme].names[rarity] && itemThemes[theme].names[rarity][itemType]) {
                    availableRarities.push(rarity);
                }
            }
        }
        return [...new Set(availableRarities)]; // Убираем дубликаты
    }

    // Функция для получения случайной редкости с весами
    function getRandomRarity() {
        const rarityRoll = Math.random();
        if (rarityRoll < 0.4) return "common";
        else if (rarityRoll < 0.7) return "uncommon";
        else if (rarityRoll < 0.85) return "rare";
        else if (rarityRoll < 0.95) return "veryRare";
        else return "legendary";
    }

    // Функция для получения случайного типа предмета
    function getRandomType() {
        const allTypes = [];
        for (const theme in itemThemes) {
            for (const rarity in itemThemes[theme].names) {
                for (const type in itemThemes[theme].names[rarity]) {
                    allTypes.push(type);
                }
            }
        }
        return random([...new Set(allTypes)]); // Убираем дубликаты
    }

    // Вспомогательная функция для получения случайного доступного типа для редкости
    function getRandomAvailableType(rarity) {
        const availableTypes = [];
        for (const theme in itemThemes) {
            if (itemThemes[theme].names[rarity]) {
                for (const type in itemThemes[theme].names[rarity]) {
                    availableTypes.push(type);
                }
            }
        }
        return random(availableTypes);
    }

    // Основная функция генерации
    function generateMagicalItem() {
        const selectedType = document.getElementById("magical-items").value;
        const selectedRarity = document.getElementById("rarity-select").value;
        
        // Определяем тип предмета
        const itemType = selectedType === "random" ? getRandomType() : selectedType;
        
        // Получаем доступные редкости для выбранного типа
        const availableRarities = getAvailableRaritiesForType(itemType);
        
        if (availableRarities.length === 0) {
            console.error("Нет доступных редкостей для типа:", itemType);
            return;
        }
        
        // Определяем финальную редкость
        let finalRarity;
        if (selectedRarity === "random") {
            // Случайная редкость из доступных
            finalRarity = random(availableRarities);
        } else {
            // Если выбранная редкость доступна - используем её, иначе берем самую высокую доступную
            finalRarity = availableRarities.includes(selectedRarity) ? 
                selectedRarity : 
                availableRarities[availableRarities.length - 1];
        }

        // Выбираем тему
        const theme = getThemeForType(itemType);

        // Генерируем свойства из выбранной темы и редкости
        const name = random(itemThemes[theme].names[finalRarity][itemType]);
        const properties = randomMultiple(itemThemes[theme].properties[finalRarity], 
            finalRarity === "legendary" ? 3 : 
            finalRarity === "veryRare" ? 2 : 1);
        const features = randomMultiple(itemFeatures[finalRarity], 1);
        const effects = randomMultiple(itemEffects[finalRarity], 1);

        // Обновляем DOM
        document.getElementById("item-name").textContent = name;
        document.getElementById("item-rarity").textContent = rarities[finalRarity].name;
        document.getElementById("item-rarity").style.color = rarities[finalRarity].color;
        document.getElementById("item-type").textContent = itemType;
        document.getElementById("item-rarity-detail").textContent = rarities[finalRarity].name;
        document.getElementById("item-properties").textContent = properties;
        document.getElementById("item-features").textContent = features;
        document.getElementById("item-effects").textContent = effects;
    }

    // Вешаем обработчик на кнопку
    document.getElementById("generate-items").addEventListener("click", generateMagicalItem);

    // Генерируем первый предмет при загрузке
    generateMagicalItem();
});